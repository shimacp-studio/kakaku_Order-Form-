<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>発注カタログ | Blue Luxe v31 (mobile header centered)</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --bg:#f6f8ff; --card:#ffffff; --ink:#0b1220; --muted:#5870a3;
    --line:#e5e7ef; --line-strong:#d7dcf2;
    --accent:#1e40af; --accent-2:#2563eb;
    --cta:#2563eb; --cta-text:#ffffff;
    --chip:#f2f6ff; --qty:#3b82f6;
    --shadow:0 10px 28px rgba(30,64,175,.08), 0 3px 10px rgba(30,64,175,.06);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif}
  a{color:var(--accent-2);text-decoration:none}
  img{max-width:100%;display:block}
  button{font:inherit}

  /* ===== ヘッダ（共通） ===== */
  header{position:sticky;top:0;z-index:50;background:#fffffff2;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(8px)}
  .wrap{max-width:1280px;margin:0 auto;padding:8px 14px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;min-width:0}
  .brand img{height:44px;width:auto;object-fit:contain}
  .brand h1{font-size:22px;margin:0;font-weight:900;letter-spacing:.03em;white-space:nowrap}
  .actions{display:flex;align-items:center;gap:8px}
  .carticon{position:relative;display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:999px;border:1px solid var(--line-strong);background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.04);cursor:pointer}
  .carticon img{width:22px;height:22px;object-fit:contain;opacity:.95}
  .carticon .count{position:absolute;right:-4px;top:-4px;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:var(--accent-2);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.25)}
  .btn{background:var(--cta);color:var(--cta-text);border:1px solid #1d4fd8;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);white-space:nowrap}
  .btn.primary{background:var(--accent-2)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
  .input, select{background:#fff;border:1px solid var(--line-strong);border-radius:10px;padding:10px 12px;min-width:180px;color:var(--ink);outline:none}

  /* ===== レイアウト ===== */
  main{display:grid;grid-template-columns:minmax(0,1fr) 360px;gap:18px;max-width:1280px;margin:14px auto;padding:0 14px}
  @media (max-width:1100px){ main{grid-template-columns:1fr} .cart{position:static} }
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}

  /* ======= モバイル（〜640px） ======= */
  @media (max-width:640px){
    header{padding-bottom:4px}
    .wrap{padding:8px 10px;max-width:680px}
    /* タイトル＆検索群の中央寄せレイアウト */
    .topbar{flex-direction:column; align-items:center; justify-content:center; gap:8px; }
    .brand{justify-content:center}
    .brand img{height:36px}
    .brand h1{font-size:18px;text-align:center;white-space:normal;line-height:1.12}
    .actions{justify-content:center}
    .actions .btn{padding:8px 12px;font-size:16px}
    .carticon{width:36px;height:36px}

    /* 検索群は1列で中央寄せ（カード幅と揃える） */
    .controls{gap:8px;margin-top:8px;display:grid;grid-template-columns:1fr;justify-items:center}
    .controls .input, .controls select{min-width:0;width:100%;max-width:520px;font-size:16px;padding:10px 12px}
    .controls > :first-child{grid-column:auto}

    main{margin:10px auto;padding:0 10px}
    .grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}

    /* ---- カードをコンパクト化 ---- */
    .card{--pad:7px;border-radius:12px}
    .badge{font-size:15px;padding:6px 12px 6px 13px}
    .thumb{min-height:92px}
    .thumb img{max-width:90%;max-height:90%}
    .body{gap:5px;padding:var(--pad)}
    .title{font-size:13px;line-height:1.25;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;margin:0}

    /* スマホ向けJAN/価格：ミニバーコード付きで圧縮 */
    .mobile-janset{display:grid !important;gap:4px;justify-items:start}
    .mobile-janset .digits{font-size:11.5px;color:#0b1220}
    .mobile-janset .prices{display:flex;gap:10px;font-size:12px;flex-wrap:wrap}
    .mobile-janset .barrow{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .mobile-janset .bar{width:100px;height:16px}
    .desk-janset{display:none !important}

    /* iOSフォーカス拡大防止：16px以上を維持 */
    .qtyrow{grid-template-columns:86px 1fr;gap:6px}
    .qty, .input, select, button{font-size:16px}
    .qty{padding:9px 10px}
    .btn{padding:10px 10px}
  }

  /* ===== カード（共通） ===== */
  .card{position:relative;background:var(--card);border:1px solid var(--accent);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow)}
  .badge{position:absolute;top:0;left:0;background:var(--accent);color:#fff;font-weight:900;font-size:17px;padding:8px 14px 8px 16px;border-bottom-right-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.18)}
  .thumb{flex:0 0 40%; min-height:150px; display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--line);background:#fff}
  .thumb img{max-width:92%;max-height:92%}
  .body{--pad:12px;flex:1 1 auto; display:grid; gap:8px; padding:var(--pad)}
  .title{font-weight:800;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.8em}

  /* PC/印刷用のJAN+価格（従来どおり） */
  .desk-janset .janrow{display:flex; align-items:flex-end; justify-content:space-between; gap:10px}
  .desk-janset .barsvg svg{max-width:170px; height:26px; display:block}
  .desk-janset .digits{font-size:11px; letter-spacing:.35px; color:#0b1220}
  .desk-janset .price{font-weight:800; white-space:nowrap; color:#0b1220}
  .mobile-janset{display:none}

  .qtyrow{display:grid;grid-template-columns:92px 1fr;gap:10px;align-items:center;margin-top:auto;min-width:0}
  .qty{border:1px solid var(--line-strong);border-radius:10px;padding:10px 12px;width:100%}
  .qty:focus{outline:2px solid var(--qty); outline-offset:1px}

  /* ===== カート ===== */
  .cart{position:sticky;top:86px;max-height:calc(100dvh - 120px);background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow)}
  .cart h2{margin:0 0 4px 0;font-size:16px}
  .cartlist{flex:1;overflow:auto;border-top:1px dashed var(--line);padding-top:8px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}

  /* ===== 印刷（A4 3x4 既存踏襲） ===== */
  @page { size: A4 portrait; margin: 9mm; }
  @media print{
    header, .actions, .controls, .cart, .qtyrow{ display:none !important; }
    body{background:#fff;margin:0;padding:0;color:var(--ink)}
    main{display:block;margin:0;padding:0}
    .sheet{width: calc(210mm - 18mm);height: calc(297mm - 18mm);margin: 0 auto;display:grid;grid-template-columns: repeat(3, 1fr);column-gap: 3.6mm; row-gap: 3.6mm;grid-auto-rows: 67mm;}
    #grid{display:contents}
    .card{height:67mm;min-height:0;border:1px solid #d1d5db;border-radius:7px;box-shadow:none;overflow:hidden;display:flex;flex-direction:column;page-break-inside:avoid;background:#fff}
    .badge{position:absolute;top:0;left:0;background:#0b1220;color:#fff;padding:4px 10px;border-bottom-right-radius:8px;box-shadow:none;font-size:13px}
    .thumb{flex:0 0 25mm; border-bottom:1px solid #d1d5db; display:flex;align-items:center;justify-content:center; background:#fff}
    .thumb img{max-width:92%;max-height:23.6mm}
    .body{flex:1 1 auto; padding:0.8mm 1.9mm 0.7mm; display:grid; gap:0.32mm; grid-template-rows:auto auto 1fr; align-content:start}
    .title{-webkit-line-clamp:2;font-size:10pt;line-height:1.08;min-height:1.75em;margin:0}
    .desk-janset{display:block}
    .desk-janset .janrow{gap:1.8mm}
    .desk-janset .barsvg svg{height:18px; max-width:108px}
    .desk-janset .digits{font-size:8pt; letter-spacing:.22px; margin-top:0.2mm}
    .desk-janset .price{font-size:9.2pt; line-height:1}
    .mobile-janset{display:none !important}
    .card:nth-of-type(12n){page-break-after:always;break-after:page}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img id="logo" alt="logo">
        <h1>発注カタログ</h1>
      </div>
      <div class="actions">
        <button class="btn primary" onclick="window.print()">印刷（カタログ）</button>
        <button class="carticon" title="カートへ移動" onclick="document.getElementById('cart').scrollIntoView({behavior:'smooth'})">
          <img id="cartImg" alt="Cart">
          <span class="count" id="cartCount">0</span>
        </button>
      </div>
    </div>
    <div class="controls">
      <input id="q" class="input" placeholder="検索（商品名 / ブランド / カテゴリ / JAN）" oninput="filterGrid()">
      <select id="cat" class="input" onchange="filterGrid()"><option value="">すべてのカテゴリ</option></select>
      <input id="buyerName" class="input" placeholder="発注者名（履歴に保存）" oninput="localStorage.setItem('buyerName', this.value)">
    </div>
  </div>
</header>

<main>
  <section class="sheet">
    <div class="grid" id="grid"></div>
  </section>

  <aside class="cart" id="cart">
    <h2>カート</h2>
    <div id="cartlist" class="cartlist"></div>
    <div class="total">
      <div class="row"><span>小計（税抜）</span><span id="subtotal">0円</span></div>
      <div class="row"><span>消費税</span><span id="tax">0円</span></div>
      <div class="row" style="font-weight:800"><span>税込合計</span><span id="grand">0円</span></div>
      <hr style="border:0;border-top:1px dashed var(--line)">
      <input id="username" class="input" placeholder="ご担当者名 / 店舗名など（メールに記載）">
      <input id="note" class="input" placeholder="伝達事項（任意）">
      <button class="btn" id="submit">この内容で発注する</button>
    </div>
  </aside>
</main>

<script>
const REPO = "kakaku_Order-Form-";
const BASE = `https://${location.host}/${REPO}`;
const CDN  = "https://cdn.jsdelivr.net/gh/shimacp-studio/kakaku_Order-Form-@main";

/* 画像候補 */
function pickImage(imgEl, paths){
  let i=0; const tryNext=()=>{ if(i>=paths.length){ imgEl.style.opacity='.35'; imgEl.onerror=null; return; } imgEl.src=paths[i++]; };
  imgEl.onerror=tryNext; tryNext();
}

/* ファイル名ゆらぎ吸収 */
const cartCandidates = [`${BASE}/img/KART.PNG`, `${BASE}/img/KART.png`, `${BASE}/img/cart.png`, `${BASE}/img/Cart.png`, `${BASE}/img/KRAT.png`];
const logoCandidates = [`${BASE}/img/shima_owl.png`, `${BASE}/img/shima_owl.PNG`, `${BASE}/img/shima_owl.jpg`, `${BASE}/img/shima_owl.svg`, `${BASE}/img/シマフクロウロゴ.png`];

async function fetchFirstJSON(urls){
  let lastErr=null;
  for(const u of urls){
    try{const r=await fetch(u,{cache:"no-store"}); if(r.ok) return await r.json(); lastErr=new Error(r.status+'@'+u);}catch(e){lastErr=e;}
  }
  throw lastErr||new Error('load error');
}
function candidates(jan){
  const exts=['png','jpg','jpeg','webp','jfif','PNG','JPG','JPEG','WEBP','JFIF'];
  const bases=[`${BASE}/img/`,`${BASE}/img/jan/`,`${BASE}/img/barcode/`];
  const arr=[]; for(const b of bases){for(const e of exts){arr.push(`${b}${jan}.${e}`)}} return arr;
}
function setBest(img, urls){let i=0; function next(){ if(i>=urls.length){img.src=''; img.onerror=null; return;} img.src=urls[i++]; } img.onerror=next; next(); }
function onlyDigits(s){return (s||'').replace(/[^0-9]/g,'');}
function money(n){return (Number(n)||0).toLocaleString()+'円';}

/* EAN13 → SVG（PC/印刷用） */
const L=['0001101','0011001','0010011','0111101','0100011','0110001','0101111','0111011','0110111','0001011'];
const G=['0100111','0110011','0011011','0100001','0011101','0111001','0000101','0010001','0001001','0010111'];
const R=['1110010','1100110','1101100','1000010','1011100','1001110','1010000','1000100','1001000','1110100'];
const PAR={'0':'LLLLLL','1':'LLGLGG','2':'LLGGLG','3':'LLGGGL','4':'LGLLGG','5':'LGGLLG','6':'LGGGLL','7':'LGLGLG','8':'LGLGGL','9':'LGGLGL'};
function cd12(d){let s=0; for(let i=0;i<12;i++){const n=+d[i]; s+=(i%2===0)?n:n*3;} return (10-(s%10))%10;}
function pat(d){const ds=onlyDigits(d); if(ds.length<12) return null; const d12=ds.slice(0,12); const cd=(ds.length>=13)?+ds[12]:cd12(d12);
  const first=d12[0], left=d12.slice(1,7), right=d12.slice(7,12)+String(cd), parity=PAR[first]||'LLLLLL'; let bits='101';
  for(let i=0;i<6;i++){const n=+left[i]; bits+= (parity[i]==='L'?L[n]:G[n]);} bits+='01010'; for(let i=0;i<6;i++){ bits+=R[+right[i]];} bits+='101'; return bits; }
function svg(jan,w=110,h=22){const bits=pat(jan); if(!bits) return ''; const barW=Math.max(1,Math.floor(w/bits.length)); const W=barW*bits.length; const hg=Math.floor(h*0.92);
  let x=0,s=`<svg viewBox='0 0 ${W} ${h}' xmlns='http://www.w3.org/2000/svg' shape-rendering='crispEdges'><rect width='${W}' height='${h}' fill='#fff'/>`;
  for(let i=0;i<bits.length;i++){ if(bits[i]==='1'){const g=(i<3)||(i>=45&&i<50)||(i>=92); s+=`<rect x='${x}' y='0' width='${barW}' height='${g?h:hg}' fill='${'#0b1220'}'/>`; } x+=barW; } return s+`</svg>`; }
function miniSvg(jan,w=100,h=16){return svg(jan,w,h)}

let PRODUCTS=[], CART=JSON.parse(localStorage.getItem('cart.v1')||'[]');

function renderGrid(list){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  list.forEach((p,idx)=>{
    const price = (p.price!=null)? Number(p.price)||0 : null;
    const gross = (price!=null)? Math.round(price*1.1) : null;
    const el=document.createElement('article');
    el.className='card';
    el.innerHTML=`
      <div class="badge">${idx+1}</div>
      <div class="thumb"><img alt=""></div>
      <div class="body">
        <div class="title" title="${p.name||""}">${p.name||""}</div>

        <!-- PC/印刷用 -->
        <div class="desk-janset">
          <div class="janrow">
            <div class="price">税抜：${price!=null? price.toLocaleString()+"円":""}</div>
            <div class="barsvg">${svg(p.jan)}</div>
          </div>
          <div class="janrow">
            <div class="price">税込：${gross!=null? gross.toLocaleString()+"円": ""}</div>
            <div class="digits">${p.jan||""}</div>
          </div>
        </div>

        <!-- スマホ用（ミニバーコード付き） -->
        <div class="mobile-janset">
          <div class="barrow">
            <div class="bar">${miniSvg(p.jan)}</div>
            <div class="digits">${p.jan||""}</div>
          </div>
          <div class="prices">
            <div>税抜：${price!=null? price.toLocaleString()+"円":""}</div>
            <div>税込：${gross!=null? gross.toLocaleString()+"円": ""}</div>
          </div>
        </div>

        <div class="qtyrow">
          <input type="number" inputmode="numeric" pattern="[0-9]*" min="0" step="1" class="qty" id="qty-${p.jan}" placeholder="数量">
          <button class="btn" onclick="addToCart('${p.jan}')">カートへ</button>
        </div>
      </div>`;
    grid.appendChild(el);
    setBest(el.querySelector('img'), candidates(p.jan));
  });
}

function renderCart(){
  const list=document.getElementById('cartlist'); list.innerHTML='';
  if(CART.length===0){ list.innerHTML='<div class="muted">カートは空です</div>'; }
  CART.forEach((it)=>{
    const p=PRODUCTS.find(x=>x.jan===it.jan)||{name:""};
    const row=document.createElement('div');
    row.className="cartitem row";
    row.innerHTML=`
      <div style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.name||it.jan}</div>
      <input type="number" min="0" step="1" value="${it.qty}" oninput="updateQty('${it.jan}', this.value)" style="width:70px">
      <div style="text-align:right;width:110px">${money((p.price||0)*it.qty)}</div>
      <button onclick="removeFromCart('${it.jan}')" style="border:0;background:#fff;cursor:pointer">✕</button>`;
    list.appendChild(row);
  });
  const subtotal=CART.reduce((s,it)=>{const p=PRODUCTS.find(x=>x.jan===it.jan)||{}; return s + (Number(p.price)||0)*it.qty;},0);
  const tax=Math.round(subtotal*0.1);
  const grand=subtotal+tax;
  document.getElementById('subtotal').textContent=money(subtotal);
  document.getElementById('tax').textContent=money(tax);
  document.getElementById('grand').textContent=money(grand);
  localStorage.setItem('cart.v1', JSON.stringify(CART));
  updateCartCount();
}
function updateCartCount(){ document.getElementById('cartCount').textContent = CART.reduce((s,it)=>s+Number(it.qty||0),0); }
function addToCart(jan){
  const qtyEl=document.getElementById(`qty-${jan}`);
  const q=Math.max(1, Number(qtyEl && qtyEl.value || 1));
  const ex=CART.find(x=>x.jan===jan);
  if(ex) ex.qty += q; else CART.push({jan, qty:q});
  qtyEl && (qtyEl.value = '');
  renderCart();
}
function updateQty(jan,val){
  const it=CART.find(x=>x.jan===jan); if(!it) return;
  it.qty=Math.max(0, Number(val)||0);
  if(it.qty===0) CART=CART.filter(x=>x.jan!==jan);
  renderCart();
}
function removeFromCart(jan){ CART=CART.filter(x=>x.jan!==jan); renderCart(); }

function filterGrid(){
  const q=(document.getElementById('q').value||'').trim().toLowerCase();
  const cat=document.getElementById('cat').value||'';
  const list=PRODUCTS.filter(p=>{
    const hitQ = !q || JSON.stringify(p).toLowerCase().includes(q);
    const hitC = !cat || (p.category||'')===cat;
    return hitQ && hitC;
  });
  renderGrid(list);
}

async function boot(){
  pickImage(document.getElementById('cartImg'), [`${BASE}/img/KART.PNG`, `${BASE}/img/KART.png`, `${BASE}/img/cart.png`, `${BASE}/img/Cart.png`, `${BASE}/img/KRAT.png`]);
  pickImage(document.getElementById('logo'), [`${BASE}/img/shima_owl.png`, `${BASE}/img/shima_owl.PNG`, `${BASE}/img/shima_owl.jpg`, `${BASE}/img/shima_owl.svg`, `${BASE}/img/シマフクロウロゴ.png`]);

  const here=(new URL('./products.json',location.href)).href;
  const prods=await fetchFirstJSON([here,`${BASE}/products.json`,`${CDN}/products.json`]);
  PRODUCTS=Array.isArray(prods)?prods:[];
  const set=new Set(PRODUCTS.map(p=>p.category).filter(Boolean)); const sel=document.getElementById('cat');
  [...set].sort().forEach(c=>{const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);});
  renderGrid(PRODUCTS);
  renderCart();
  document.getElementById('submit').addEventListener('click', ()=>alert('送信先未設定です（GASやメール連携を有効化してください）'));
}
boot().catch(e=>{console.error(e); alert("初期化エラー: "+e.message);});
</script>
</body>
</html>
