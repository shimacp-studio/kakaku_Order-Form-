<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>発注アプリ</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --bg:#f7fafa;--card:#ffffff;--ink:#111827;--muted:#4b5563;--line:#e5e7eb;
    --accent:#0073bb;--cta:#ffd814;--cta-border:#f3cc00;--chip:#f3f4f6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif}
  a{color:var(--accent);text-decoration:none}
  header{position:sticky;top:0;z-index:30;background:#ffffffcc;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(6px)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{height:28px;width:auto;object-fit:contain}
  h1{font-weight:700;font-size:22px;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
  .input, select{background:#fff;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:10px 12px;outline:none;min-width:180px}
  .btn{background:var(--cta);color:#111827;border:1px solid var(--cta-border);border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.05)}
  .btn.primary{background:var(--accent);color:#fff;border-color:#005d96;border-radius:8px}
  main{display:grid;grid-template-columns:1fr 360px;gap:16px;max-width:1200px;margin:16px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:480px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
  .card .corner{position:absolute;top:0;left:0;width:0;height:0;border-top:34px solid #ff9900;border-right:34px solid transparent}
  .card .corner span{position:absolute;top:-28px;left:3px;color:#fff;font-weight:700;font-size:13px}
  .card .thumb{background:#fff;aspect-ratio:3/2;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--line)}
  .card .thumb img{max-width:90%;max-height:90%}
  .card .body{padding:12px;display:grid;gap:8px}
  .title{font-weight:700;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:3.4em}
  .barcode{display:flex;justify-content:flex-start;align-items:flex-start;padding-top:2px;min-height:48px}
  .barcode .box{background:#ffffff;padding:2px 6px;border-radius:6px;border:1px solid var(--line)}
  .barcode svg{max-width:140px;height:34px;display:block}
  .barcode .digits{color:#111827;font-size:11px;text-align:left;margin-top:2px;letter-spacing:.6px}
  .meta{display:flex;gap:6px;flex-wrap:wrap;min-height:26px}
  .chip{background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px;color:#374151;font-size:12px}
  .pricebox{display:flex;align-items:baseline;gap:8px;min-height:22px}
  .pricebox .label{color:#6b7280;font-size:12px}
  .pricebox .value{font-weight:700;font-size:18px}
  .qtyrow{display:grid;grid-template-columns:90px 1fr;gap:10px;align-items:center}
  .qty{background:#fff;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px 10px;width:100%}
  .btn.wide{width:100%}
  .cart{position:sticky;top:76px;height:calc(100dvh - 92px);background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .cart h2{margin:0 0 4px 0;font-size:16px}
  .cartlist{flex:1;overflow:auto;border-top:1px dashed var(--line);padding-top:8px}
  .cartitem{display:grid;grid-template-columns:1fr 64px 84px 24px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed #e5e7eb}
  .total{border-top:1px solid var(--line);padding-top:8px;display:grid;gap:6px}
  footer{max-width:1200px;margin:24px auto;padding:0 16px;color:#6b7280}

  /* ===== 印刷：A4縦・3列×4段（12アイテム/ページ） ===== */
  @page { size: A4 portrait; margin: 10mm; }
  @media print{
    header, .toolbar, .cart, .controls .btn, .qtyrow { display:none !important; }
    body{background:#fff}
    main{display:block}
    .grid{grid-template-columns:repeat(3,1fr);gap:8mm}
    .card{min-height:0;height:auto;border:1px solid #cbd5e1;box-shadow:none;page-break-inside:avoid;overflow:visible}
    .card .thumb{height:40mm;aspect-ratio:auto;border-bottom:1px solid #cbd5e1}
    .barcode svg{height:22px;max-width:110px}
    .barcode .digits{font-size:10px}
    .print-qty{display:block !important}
    .card:nth-of-type(12n){page-break-after:always;break-after:page}
  }
  .print-qty{display:none}
  .print-qty .lbl{font-size:12px;color:#374151}
  .print-qty .box{height:24px;border:1px dashed #9ca3af;border-radius:6px;margin-top:4px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <img id="logo" src="${location.origin}/kakaku_Order-Form-/img/shima_owl.png" alt="Shima Owl Logo" onerror="this.style.display='none'">
      <h1>発注アプリ</h1>
    </div>
    <div class="controls">
      <input id="q" class="input" placeholder="検索（商品名 / ブランド / カテゴリ / JAN）">
      <select id="cat" class="input"><option value="">すべてのカテゴリ</option></select>
      <input id="buyerName" class="input" placeholder="発注者名（履歴に保存）">
      <button class="btn primary" onclick="window.print()">印刷（カタログ）</button>
    </div>
  </div>
</header>

<main>
  <section>
    <div class="grid" id="grid"></div>
  </section>

  <aside class="cart">
    <div class="toolbar">
      <button class="btn ghost" id="clearCart">カートを空にする</button>
    </div>
    <h2>カート</h2>
    <div id="cartlist" class="cartlist"></div>
    <div class="total">
      <div><span class="muted">小計（税抜）</span>：<span id="subtotal">-</span></div>
      <div><span class="muted">消費税</span>：<span id="tax">-</span></div>
      <div style="font-weight:700"><span>税込合計</span>：<span id="grand">-</span></div>
      <hr style="border:0;border-top:1px dashed var(--line)">
      <input id="username" class="input" placeholder="ご担当者名 / 店舗名など（メールに記載）">
      <input id="note" class="input" placeholder="伝達事項（任意）">
      <button class="btn" id="submit">この内容で発注する</button>
      <div class="muted" style="font-size:12px">発注後、mail_list の全アドレスへメール送信されます。</div>
    </div>
  </aside>
</main>

<footer>印刷はA4縦で3列×4段=12件/ページ。カードは通常と同じ情報（タイトル/JAN/メタ/価格）＋印刷専用の発注数量欄を表示。</footer>

<script>
const REPO = "kakaku_Order-Form-";
const BASE = `https://${location.host}/${REPO}`;
const CDN  = "https://cdn.jsdelivr.net/gh/shimacp-studio/kakaku_Order-Form-@main";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxENvVA9HBRstHtTFn2NbT8jjtMvV77MhZcBFfa4HK0ZxHxvqSY9BxrL2G2Er91jVrFEw/exec";

async function fetchFirstJSON(urls){
  let lastErr = null;
  for(const u of urls){
    try{
      const res = await fetch(u, {cache:"no-store"});
      if(res.ok) return await res.json();
      lastErr = new Error("HTTP " + res.status + " on " + u);
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error("No sources available");
}
function buildImageCandidates(jan){
  const exts = ["png","jpg","jpeg","webp","jfif","PNG","JPG","JPEG","WEBP","JFIF"];
  const bases = [`${BASE}/img/`, `${BASE}/img/jan/`, `${BASE}/img/barcode/`];
  const arr = [];
  for(const b of bases){ for(const e of exts){ arr.push(`${b}${jan}.${e}`); } }
  return arr;
}
function svgPlaceholder(){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='450'><rect width='100%' height='100%' fill='#f3f4f6'/><g fill='#6b7280' font-family='system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP' text-anchor='middle'><text x='50%' y='52%' font-size='18'>NO IMAGE</text></g></svg>`;
  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
}
function setBestImage(imgEl, candidates){
  let i = 0;
  function tryNext(){
    if(i >= candidates.length){ imgEl.src = svgPlaceholder(); imgEl.onerror = null; return; }
    imgEl.src = candidates[i++];
  }
  imgEl.onerror = tryNext;
  tryNext();
}
function money(n){ if(n==null || isNaN(n)) return "-"; return n.toLocaleString() + "円"; }
function onlyDigits(s){ return (s||"").replace(/[^0-9]/g,""); }
// EAN-13
const L = ["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"];
const G = ["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"];
const R = ["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"];
const PARITY = {"0":"LLLLLL","1":"LLGLGG","2":"LLGGLG","3":"LLGGGL","4":"LGLLGG","5":"LGGLLG","6":"LGGGLL","7":"LGLGLG","8":"LGLGGL","9":"LGGLGL"};
function ean13Checksum12(d12){
  let sum = 0;
  for(let i=0;i<12;i++){ const n = +d12[i]; sum += (i%2===0) ? n : n*3; }
  return (10 - (sum%10)) % 10;
}
function ean13Pattern(digits){
  const ds = onlyDigits(digits);
  if(ds.length < 12) return null;
  const d12 = ds.slice(0,12);
  const cd  = (ds.length>=13) ? +ds[12] : ean13Checksum12(d12);
  const first = d12[0], left = d12.slice(1,7), right = d12.slice(7,12) + String(cd);
  const parity = PARITY[first] || "LLLLLL";
  let bits = "101";
  for(let i=0;i<6;i++){ const d = +left[i]; bits += (parity[i]==="L" ? L[d] : G[d]); }
  bits += "01010";
  for(let i=0;i<6;i++){ const d = +right[i]; bits += R[d]; }
  bits += "101";
  return bits;
}
function renderEAN13SVG(jan, width=110, height=22){
  const ds = onlyDigits(jan); if(ds.length<12) return "";
  const bits = ean13Pattern(ds); if(!bits) return "";
  const barW = Math.max(1, Math.floor(width / bits.length));
  const svgW = barW * bits.length;
  const hGuard = Math.floor(height * 0.92);
  const hFull  = height;
  let x = 0, out = `<svg viewBox='0 0 ${svgW} ${height}' xmlns='http://www.w3.org/2000/svg' shape-rendering='crispEdges'>`;
  out += `<rect x='0' y='0' width='${svgW}' height='${height}' fill='#ffffff'/>`;
  for(let i=0;i<bits.length;i++){
    if(bits[i]==='1'){
      const isGuard = (i<3) || (i>=45 && i<50) || (i>=92);
      const h = isGuard ? hFull : hGuard;
      out += `<rect x='${x}' y='0' width='${barW}' height='${h}' fill='#111827'/>`;
    }
    x += barW;
  }
  out += `</svg>`;
  return out;
}

let PRODUCTS = [];
let CART = JSON.parse(localStorage.getItem("cart.v1")||"[]");

function renderGrid(list){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  if(list.length===0){ grid.innerHTML = '<div class="empty">該当商品がありません</div>'; return; }
  list.forEach((p,idx)=>{
    const el = document.createElement("div");
    el.className = "card";
    const imgCandidates = buildImageCandidates(p.jan);
    const barcodeSVG = renderEAN13SVG(p.jan);
    el.innerHTML = `
      <div class="corner"><span>${(idx+1)}</span></div>
      <div class="card-inner">
        <div class="thumb"><img alt="${p.name}" id="thumb-${p.jan}"></div>
        <div class="body">
          <div class="title">${p.name}</div>
          <div class="barcode">
            <div class="box">
              ${barcodeSVG || `<div class="digits">JAN：${p.jan || "-"}</div>`}
              ${barcodeSVG ? `<div class="digits">${p.jan || ""}</div>` : ""}
            </div>
          </div>
          <div class="meta">
            ${p.brand?`<span class="chip">#${p.brand}</span>`:""}
            ${p.category?`<span class="chip">${p.category}</span>`:""}
            ${p.pack?`<span class="chip">入数 ${p.pack}</span>`:""}
          </div>
          <div class="pricebox"><span class="label">単価（税抜）</span><span class="value">${money(p.price)}</span></div>
          <div class="qtyrow">
            <input type="number" min="0" step="1" class="qty" placeholder="数量" id="qty-${p.jan}">
            <button class="btn wide" onclick="addToCart('${p.jan}')">カートへ</button>
          </div>
          <div class="print-qty">
            <div class="lbl">発注数量：</div>
            <div class="box"></div>
          </div>
        </div>
      </div>`;
    grid.appendChild(el);
    const t = el.querySelector(`#thumb-${p.jan}`);
    if(t) setBestImage(t, imgCandidates);
  });
}

function renderCart(){
  const list = document.getElementById("cartlist");
  list.innerHTML = "";
  if(CART.length===0){ list.innerHTML = '<div class="empty">カートは空です</div>'; }
}

function money(n){ if(n==null || isNaN(n)) return "-"; return n.toLocaleString() + "円"; }

async function boot(){
  const here = (new URL('./products.json', location.href)).href;
  const prods = await fetchFirstJSON([ here, `${BASE}/products.json`, `${CDN}/products.json` ]);
  PRODUCTS = Array.isArray(prods) ? prods : [];
  renderGrid(PRODUCTS);
  renderCart();
}
boot().catch(err=>{ console.error(err); alert("初期化エラー: " + err.message); });
</script>
</body>
</html>
