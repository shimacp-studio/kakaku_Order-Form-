<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ã‚·ãƒã‚³ãƒ¼ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ç™ºæ³¨ã‚«ã‚¿ãƒ­ã‚°</title>
<style>
:root{
  --ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--bg:#f6f8ff;--card:#fff;--brand:#1e66ff;--accent:#155eef;--shadow:0 4px 16px rgba(16,24,40,.06);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
h1{margin:0;font-size:clamp(18px,3.4vw,26px);font-weight:800}
header{position:sticky;top:0;z-index:30;background:#ffffffcc;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(6px)}
.wrap{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
.brand{display:flex;align-items:center;gap:10px;}
.brand img{height:38px;width:auto}
.actions{display:flex;gap:12px;align-items:center}
.btn{background:var(--brand);color:#fff;border:1px solid #1243c1;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer;font-size:13px;transition:0.3s}
.btn:disabled{opacity:.5;cursor:not-allowed}

.controls{max-width:1200px;margin:10px auto;display:grid;gap:8px;padding:0 16px;grid-template-columns:repeat(3,1fr);}
.input{background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:14px;}

main{display:grid;grid-template-columns:1fr 340px;gap:16px;max-width:1200px;margin:14px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.card{position:relative;background:var(--card);border:1px solid #d6e0ff;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow);padding-bottom:10px}
.thumb{aspect-ratio:3/2;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--line);background:#fff}
.thumb img{max-width:92%;max-height:92%;object-fit:contain}
.body{padding:10px 12px;display:grid;gap:6px}
.title{font-weight:700;font-size:12px;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.6em}
.barcode svg{height:18px;width:80px;}
.price{font-weight:800;font-size:13px}
.actions-card{display:flex;align-items:center;justify-content:space-between;margin-top:auto;padding:0 10px}
.qtyinput{width:70px;text-align:center;border:1px solid var(--line);border-radius:8px;padding:4px}

.cart{position:sticky;top:84px;height:calc(100dvh - 100px);background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow)}
.cartlist{flex:1;overflow:auto;border-top:1px dashed var(--line);padding-top:8px}
.cartitem{display:grid;grid-template-columns:1fr 62px 70px 24px;gap:6px;align-items:center;padding:6px 0;border-bottom:1px dashed #e5e7eb}

@page{size:A4 portrait;margin:10mm}
@media print{
  header,.actions,.cart,.actions-card,.qtyinput,.controls{display:none!important}
  body{background:#fff}
  main{display:block;margin:0;padding:0}
  .grid{grid-template-columns:repeat(2,1fr)!important;gap:6mm;width:calc(210mm - 20mm);margin:35mm auto 0;}
  .card{flex-direction:row;align-items:flex-start;gap:4mm;border:1px solid #ccc;box-shadow:none;padding:4mm;height:calc((297mm - 70mm)/5);page-break-inside:avoid;}
  .thumb{flex:0 0 45mm;height:auto;display:flex;align-items:center;justify-content:center;border:none;}
  .thumb img{max-height:40mm;max-width:100%;object-fit:contain;}
  .body{flex:1;display:flex;flex-direction:column;justify-content:flex-start;gap:2mm;}
  .title{font-size:11pt;font-weight:700;}
  .barcode svg{height:18px;width:80px;}
  .price{font-size:10.5pt;}
  .qtyline{font-size:11pt;margin-top:2mm;border-top:1px solid #ccc;padding-top:1mm;}
  .header-print{position:fixed;top:5mm;left:0;width:100%;display:flex;align-items:center;justify-content:center;gap:8px;}
  .header-print img{height:14mm;width:auto;}
  .header-print h2{font-size:16pt;font-weight:800;margin:0;}
  .footer-print{position:fixed;bottom:5mm;left:0;width:100%;text-align:center;font-size:11pt;border-top:1px solid #ccc;padding-top:3mm;background:#fff}
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <img src="img/shima_owl.jpg" alt="logo">
      <h1>ã‚·ãƒã‚³ãƒ¼ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ç™ºæ³¨ã‚«ã‚¿ãƒ­ã‚°</h1>
    </div>
    <div class="actions">
      <button class="btn" onclick="window.print()">å°åˆ·ï¼ˆA4ç¸¦10ä»¶ï¼‰</button>
    </div>
  </div>
</header>
<div class="controls">
  <input id="buyerName" class="input" placeholder="ç™ºæ³¨è€…å">
  <input id="partnerName" class="input" placeholder="ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼æ¥­">
  <input id="siteName" class="input" placeholder="ç¾å ´å">
</div>
<main>
  <section><div id="grid" class="grid"></div></section>
  <aside class="cart">
    <h2>ã‚«ãƒ¼ãƒˆ</h2>
    <div id="cartlist" class="cartlist"></div>
    <div><strong>å°è¨ˆï¼š</strong><span id="subtotal">0å††</span><br><strong>ç¨è¾¼ï¼š</strong><span id="total">0å††</span></div>
    <button id="orderBtn" class="btn">ã“ã®å†…å®¹ã§ç™ºæ³¨</button>
  </aside>
</main>
<div class="header-print">
  <img src="img/shima_owl.jpg" alt="logo">
  <h2>ã‚·ãƒã‚³ãƒ¼ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ç™ºæ³¨ã‚«ã‚¿ãƒ­ã‚°</h2>
</div>
<div class="footer-print">
  ç™ºæ³¨è€…åï¼šï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ã€€æ—¥ä»˜ï¼šï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ã€€å‚™è€ƒï¼šï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿
</div>

<script>
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxGz8VCT8IkE_8nPOX7vVh-CMGkpOVPsnIhbO-FEViWKcP6KAapatDeusREagPta62kuA/exec";

function ean13Pattern(d){const L=["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],G=["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"],R=["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"],P={"0":"LLLLLL","1":"LLGLGG","2":"LLGGLG","3":"LLGGGL","4":"LGLLGG","5":"LGGLLG","6":"LGGGLL","7":"LGLGLG","8":"LGLGGL","9":"LGGLGL"};const s=(d||"").replace(/[^0-9]/g,"");if(s.length<12)return null;const d12=s.slice(0,12),cd=(10-((d12.split("").reduce((a,b,i)=>a+Number(b)*(i%2?3:1),0))%10))%10;const first=d12[0],left=d12.slice(1,7),right=d12.slice(7,12)+cd;let bits="101",par=P[first];for(let i=0;i<6;i++){bits+=(par[i]==="L"?L[left[i]]:G[left[i]]);}bits+="01010";for(let i=0;i<6;i++){bits+=R[right[i]];}return bits+"101";}
function renderBarcode(jan){const bits=ean13Pattern(jan);if(!bits)return"";let out=`<svg viewBox='0 0 ${bits.length} 20' xmlns='http://www.w3.org/2000/svg' shape-rendering='crispEdges'><rect width='${bits.length}' height='20' fill='#fff'/>`;for(let i=0;i<bits.length;i++)if(bits[i]==="1")out+=`<rect x='${i}' y='0' width='1' height='18' fill='#000'/>`;out+="</svg>";return out;}

let cart=[];
function updateCart(){const list=document.getElementById('cartlist');list.innerHTML='';if(!cart.length){list.textContent='ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™';document.getElementById('subtotal').textContent='0å††';document.getElementById('total').textContent='0å††';return;}let subtotal=0;cart.forEach((it,i)=>{subtotal+=it.price*it.qty;list.innerHTML+=`<div class='cartitem'><div>${it.name}</div><div>${it.qty}</div><div>${(it.price*it.qty).toLocaleString()}å††</div><button onclick='removeItem(${i})' style='color:red;border:none;background:none;font-weight:800'>Ã—</button></div>`});document.getElementById('subtotal').textContent=subtotal.toLocaleString()+"å††";document.getElementById('total').textContent=Math.round(subtotal*1.1).toLocaleString()+"å††";}
function removeItem(i){cart.splice(i,1);updateCart();}

async function boot(){
  const PRODUCTS=await fetch('./products.json').then(r=>r.json());
  const grid=document.getElementById('grid');
  PRODUCTS.forEach((p)=>{
    const barcode=renderBarcode(p.jan);
    grid.innerHTML+=`<div class='card'>
      <div class='thumb'><img src='img/${p.jan}.jpg' onerror="this.src='img/noimage.jpg'"></div>
      <div class='body'>
        <div class='title'>${p.name}</div>
        <div class='barcode'>${barcode}</div>
        <div class='price'>ç¨æŠœï¼š${p.price.toLocaleString()}å††</div>
        <div class='price'>ç¨è¾¼ï¼š${Math.round(p.price*1.1).toLocaleString()}å††</div>
      </div>
      <div class='actions-card'>
        <input id='qty-${p.jan}' type='number' class='qtyinput' min='0' step='1' placeholder='æ•°é‡'>
        <button class='btn' onclick='addToCart(${JSON.stringify(p)})'>ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
      </div>
    </div>`;
  });
}
function addToCart(p){const q=document.getElementById(`qty-${p.jan}`).value;if(!q||q<=0)return;const ex=cart.find(x=>x.jan===p.jan);if(ex){ex.qty+=Number(q);}else{cart.push({...p,qty:Number(q)});}updateCart();document.getElementById(`qty-${p.jan}`).value='';}

async function sendOrder(){
  if(!cart.length)return alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
  const buyer=document.getElementById('buyerName').value.trim();
  const partner=document.getElementById('partnerName').value.trim();
  const site=document.getElementById('siteName').value.trim();
  if(!buyer)return alert('ç™ºæ³¨è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const payload={buyerName:buyer,partnerName:partner,siteName:site,items:cart.map(c=>({jan:c.jan,name:c.name,price:c.price,qty:c.qty}))};
  const btn=document.getElementById('orderBtn');
  btn.disabled=true;btn.textContent='é€ä¿¡ä¸­â€¦';
  try{
    await fetch(GAS_ENDPOINT,{
      method:'POST',
      mode:'no-cors', // ğŸ‘ˆ åŒ¿åã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œ
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    alert('âœ… ç™ºæ³¨ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
    cart=[];updateCart();
  }catch(e){
    alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š'+e.message+'\nGASãŒå…¨å“¡ã‚¢ã‚¯ã‚»ã‚¹å¯ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }finally{
    btn.disabled=false;btn.textContent='ã“ã®å†…å®¹ã§ç™ºæ³¨';
  }
}

document.getElementById('orderBtn').onclick=sendOrder;
boot();
</script>
</body>
</html>
