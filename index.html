<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>発注アプリ（通常UI＋印刷A4縦3×4固定／画像小さめ・JAN横に売価・下部数量欄）</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --bg:#f7fafa;--card:#ffffff;--ink:#111827;--muted:#4b5563;--line:#e5e7eb;
    --accent:#0073bb;--cta:#ffd814;--cta-border:#f3cc00;--chip:#f3f4f6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif}
  a{color:var(--accent);text-decoration:none}

  /* ===== 通常の発注画面 ===== */
  header{position:sticky;top:0;z-index:30;background:#ffffffcc;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(6px)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{height:28px;width:auto;object-fit:contain}
  h1{font-weight:700;font-size:22px;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
  .input, select{background:#fff;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:10px 12px;outline:none;min-width:180px}
  .btn{background:var(--cta);color:#111827;border:1px solid var(--cta-border);border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.05)}
  .btn.primary{background:var(--accent);color:#fff;border-color:#005d96;border-radius:8px}

  main{display:grid;grid-template-columns:1fr 360px;gap:16px;max-width:1200px;margin:16px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:480px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
  .card .corner{position:absolute;top:0;left:0;width:0;height:0;border-top:34px solid #ff9900;border-right:34px solid transparent}
  .card .corner span{position:absolute;top:-28px;left:3px;color:#fff;font-weight:800;font-size:13px;line-height:1}
  .thumb{background:#fff;aspect-ratio:3/2;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--line)}
  .thumb img{max-width:92%;max-height:92%}
  .body{padding:12px;display:grid;gap:8px}
  .title{font-weight:700;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:3.4em}
  .barcode{display:flex;justify-content:flex-start;align-items:flex-start;padding-top:2px;min-height:48px}
  .barcode .box{background:#ffffff;padding:2px 6px;border-radius:6px;border:1px solid var(--line)}
  .barcode svg{max-width:140px;height:34px;display:block}
  .barcode .digits{color:#111827;font-size:11px;text-align:left;margin-top:2px;letter-spacing:.6px}
  .meta{display:flex;gap:6px;flex-wrap:wrap;min-height:26px}
  .chip{background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px;color:#374151;font-size:12px}
  .pricebox{display:flex;align-items:baseline;gap:8px;min-height:22px}
  .pricebox .label{color:#6b7280;font-size:12px}
  .pricebox .value{font-weight:700;font-size:18px}
  .qtyrow{display:grid;grid-template-columns:90px 1fr;gap:10px;align-items:center}
  .qty{background:#fff;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px 10px;width:100%}
  .btn.wide{width:100%}

  .cart{position:sticky;top:76px;height:calc(100dvh - 92px);background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .cart h2{margin:0 0 4px 0;font-size:16px}
  .cartlist{flex:1;overflow:auto;border-top:1px dashed var(--line);padding-top:8px}
  .cartitem{display:grid;grid-template-columns:1fr 64px 84px 24px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed #e5e7eb}
  .total{border-top:1px solid var(--line);padding-top:8px;display:grid;gap:6px}
  footer{max-width:1200px;margin:24px auto;padding:0 16px;color:#6b7280}

  /* ===== 印刷：A4縦・3列×4段（12/ページ）・高さロック ===== */
  @page { size: A4 portrait; margin: 8.5mm; }  /* 内寸: 193×280mm */
  @media print{
    header, .controls, .cart, footer { display:none !important; }
    body{background:#fff;margin:0;padding:0}
    main{display:block;margin:0;padding:0}

    .sheet{
      width: calc(210mm - 17mm);
      height: calc(297mm - 17mm);
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      column-gap: 4mm;
      row-gap: 4mm;
      grid-auto-rows: 67mm;   /* 280 - (3*4mm) = 268 / 4 = 67mm */
    }
    #grid{display:contents} /* sheetにそのまま配置 */
    .card{height:67mm;min-height:0;border:1px solid #cbd5e1;border-radius:6px;box-shadow:none;overflow:hidden}
    /* 画像を小さく（ご要望） */
    .thumb{flex:0 0 22mm;border-bottom:1px solid #cbd5e1;display:flex;align-items:center;justify-content:center}
    .thumb img{max-width:90%;max-height:20mm}
    /* 本文を下まで使う */
    .body{padding:2mm 2.4mm 2mm;gap:1.6mm;display:grid;grid-template-rows:auto auto 1fr auto}
    .title{-webkit-line-clamp:1;font-size:10.6pt;line-height:1.22;min-height:auto}

    /* JANの横に売価を配置（行内） */
    .janrow{display:flex;align-items:center;gap:6px}
    .janrow .box{border:0.9px solid #dbe2ea;border-radius:4px;padding:1.2mm 1.8mm;background:#fff}
    .janrow .box svg{height:16px;max-width:88px;display:block}
    .janrow .digits{font-size:8.6pt;margin-top:1mm;letter-spacing:.2px}
    .sell{font-weight:800;font-size:10.4pt;white-space:nowrap}

    .meta{display:none !important}       /* 印刷では非表示 */
    .pricebox{display:none !important}   /* 旧の価格行は非表示（JAN横に移動） */

    /* 下部の空白に数量入力欄（実線） */
    .print-qty{display:block !important; align-self:end}
    .print-qty .lbl{font-size:9.8pt}
    .print-qty .box{height:9mm;border:1.4px solid #374151;border-radius:4px;margin-top:1mm}

    .card .corner{border-top-width:26px;border-right-width:26px}
    .card .corner span{top:-20px;left:2px;font-size:11px}
    .qtyrow{display:none} /* 画面用数量は印刷で非表示 */

    .card:nth-of-type(12n){page-break-after:always;break-after:page}
  }
  .print-qty{display:none}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <img id="logo" src="${location.origin}/kakaku_Order-Form-/img/shima_owl.png" alt="logo" onerror="this.style.display='none'">
      <h1>発注アプリ</h1>
    </div>
    <div class="controls">
      <input id="q" class="input" placeholder="検索（商品名 / ブランド / カテゴリ / JAN）" oninput="filterGrid()">
      <select id="cat" class="input" onchange="filterGrid()"><option value="">すべてのカテゴリ</option></select>
      <input id="buyerName" class="input" placeholder="発注者名（履歴に保存）">
      <button class="btn primary" onclick="window.print()">印刷（カタログ）</button>
    </div>
  </div>
</header>

<main>
  <section class="sheet">
    <div class="grid" id="grid"></div>
  </section>

  <aside class="cart">
    <h2>カート</h2>
    <div id="cartlist" class="cartlist"></div>
    <div class="total">
      <div>小計（税抜）：<span id="subtotal">-</span></div>
      <div>消費税：<span id="tax">-</span></div>
      <div style="font-weight:700">税込合計：<span id="grand">-</span></div>
      <hr style="border:0;border-top:1px dashed var(--line)">
      <input id="username" class="input" placeholder="ご担当者名 / 店舗名など（メールに記載）">
      <input id="note" class="input" placeholder="伝達事項（任意）">
      <button class="btn" id="submit">この内容で発注する</button>
    </div>
  </aside>
</main>

<script>
const REPO = "kakaku_Order-Form-";
const BASE = `https://${location.host}/${REPO}`;
const CDN  = "https://cdn.jsdelivr.net/gh/shimacp-studio/kakaku_Order-Form-@main";

async function fetchFirstJSON(urls){
  let lastErr=null;
  for(const u of urls){
    try{const r=await fetch(u,{cache:"no-store"}); if(r.ok) return await r.json(); lastErr=new Error(r.status+"@"+u);}catch(e){lastErr=e;}
  }
  throw lastErr||new Error("load error");
}
function candidates(jan){
  const exts=["png","jpg","jpeg","webp","jfif","PNG","JPG","JPEG","WEBP","JFIF"];
  const bases=[`${BASE}/img/`,`${BASE}/img/jan/`,`${BASE}/img/barcode/`];
  const arr=[]; for(const b of bases){for(const e of exts){arr.push(`${b}${jan}.${e}`)}} return arr;
}
function setBest(img, urls){let i=0; function next(){ if(i>=urls.length){img.src=''; img.onerror=null; return;} img.src=urls[i++]; } img.onerror=next; next(); }
function onlyDigits(s){return (s||"").replace(/[^0-9]/g,"");}
const L=["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"];
const G=["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"];
const R=["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"];
const PAR={"0":"LLLLLL","1":"LLGLGG","2":"LLGGLG","3":"LLGGGL","4":"LGLLGG","5":"LGGLLG","6":"LGGGLL","7":"LGLGLG","8":"LGLGGL","9":"LGGLGL"};
function cd12(d){let s=0; for(let i=0;i<12;i++){const n=+d[i]; s+=(i%2===0)?n:n*3;} return (10-(s%10))%10;}
function pat(d){const ds=onlyDigits(d); if(ds.length<12) return null; const d12=ds.slice(0,12); const cd=(ds.length>=13)?+ds[12]:cd12(d12);
  const first=d12[0], left=d12.slice(1,7), right=d12.slice(7,12)+String(cd), parity=PAR[first]||"LLLLLL"; let bits="101";
  for(let i=0;i<6;i++){const n=+left[i]; bits+= (parity[i]==="L"?L[n]:G[n]);} bits+="01010"; for(let i=0;i<6;i++){ bits+=R[+right[i]];} bits+="101"; return bits; }
function svg(jan,w=110,h=22){const bits=pat(jan); if(!bits) return ""; const barW=Math.max(1,Math.floor(w/bits.length)); const W=barW*bits.length; const hg=Math.floor(h*0.92);
  let x=0,s=`<svg viewBox='0 0 ${W} ${h}' xmlns='http://www.w3.org/2000/svg' shape-rendering='crispEdges'><rect width='${W}' height='${h}' fill='#fff'/>`;
  for(let i=0;i<bits.length;i++){ if(bits[i]==='1'){const g=(i<3)||(i>=45&&i<50)||(i>=92); s+=`<rect x='${x}' y='0' width='${barW}' height='${g?h:hg}' fill='#111827'/>`; } x+=barW; } return s+`</svg>`; }

let PRODUCTS=[], FILTERED=[];

function renderGrid(list){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  list.forEach((p,idx)=>{
    const el=document.createElement('article');
    el.className='card';
    el.innerHTML=`
      <div class="corner"><span>${idx+1}</span></div>
      <div class="thumb"><img alt=""></div>
      <div class="body">
        <div class="title">${p.name||""}</div>

        <!-- JAN + 売価（印刷で横並び） -->
        <div class="janrow">
          <div class="box">${svg(p.jan)}<div class="digits">${p.jan||""}</div></div>
          <div class="sell">${p.price!=null?Number(p.price).toLocaleString()+"円":""}</div>
        </div>

        <div class="meta">
          ${p.brand?`<span class="chip">#${p.brand}</span>`:""} ${p.category?`<span class="chip">${p.category}</span>`:""} ${p.pack?`<span class="chip">入数 ${p.pack}</span>`:""}
        </div>
        <div class="pricebox"><span class="label">単価（税抜）</span><span class="value">${p.price!=null?Number(p.price).toLocaleString()+"円":"-"}</span></div>

        <!-- 画面用の数量入力 -->
        <div class="qtyrow">
          <input type="number" min="0" step="1" class="qty" placeholder="数量">
          <button class="btn wide">カートへ</button>
        </div>

        <!-- 印刷時のみ表示・カード下の空白に配置 -->
        <div class="print-qty"><div class="lbl">発注数量：</div><div class="box"></div></div>
      </div>`;
    grid.appendChild(el);
    setBest(el.querySelector('img'), candidates(p.jan));
  });
}

function filterGrid(){
  const q=(document.getElementById('q').value||'').trim();
  const cat=document.getElementById('cat').value||'';
  FILTERED = PRODUCTS.filter(p=>{
    const hitQ = !q || JSON.stringify(p).toLowerCase().includes(q.toLowerCase());
    const hitC = !cat || (p.category||'')===cat;
    return hitQ && hitC;
  });
  renderGrid(FILTERED);
}

async function boot(){
  const here=(new URL('./products.json',location.href)).href;
  const prods=await fetchFirstJSON([here,`${BASE}/products.json`,`${CDN}/products.json`]);
  PRODUCTS=Array.isArray(prods)?prods:[];
  // カテゴリ候補
  const set=new Set(PRODUCTS.map(p=>p.category).filter(Boolean)); const sel=document.getElementById('cat');
  [...set].sort().forEach(c=>{const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);});
  FILTERED=[...PRODUCTS];
  renderGrid(FILTERED);
}
boot().catch(e=>{console.error(e); alert("初期化エラー: "+e.message);});
</script>
</body>
</html>
