<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>発注アプリ（A4縦・3x4=12固定 / 高さロック版）</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --bg:#f7fafa;--card:#ffffff;--ink:#111827;--muted:#4b5563;--line:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif}

  /* ===== 画面UIは省略、印刷最優先 ===== */

  /* ===== A4縦・倍率100%・3列×4段：カード高さをmmで固定 ===== */
  @page { size: A4 portrait; margin: 8.5mm; }  /* 内寸: 193mm × 280mm */
  @media print{
    body{background:#fff;margin:0;padding:0}
    header, footer { display:none !important; }

    .sheet{
      width: calc(210mm - 17mm);   /* 193mm */
      height: calc(297mm - 17mm);  /* 280mm */
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      column-gap: 4mm;           /* 横ギャップ合計 8mm */
      row-gap: 4mm;              /* 縦ギャップ合計 12mm */
      grid-auto-rows: 67mm;      /* (280 - 12) / 4 = 67mm 固定 */
    }

    .card{
      height: 67mm;              /* 二重に指定して確実にロック */
      border:0.9px solid #cbd5e1;
      border-radius:6px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      page-break-inside:avoid;
    }

    /* 中身の比率：画像 40% / 情報 60%（高さ固定下で余白を最小化） */
    .thumb{flex: 0 0 26.5mm; border-bottom:0.9px solid #dbe2ea; display:flex;align-items:center;justify-content:center;background:#fff}
    .thumb img{max-width:92%;max-height:24.5mm}

    .body{flex:1 1 auto; padding: 2mm 2.4mm 2mm; display:grid; gap: 1.6mm; align-content:start}
    .title{font-size: 10.6pt; line-height: 1.22; display:-webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow:hidden;}

    /* JANバーコード */
    .barcode{display:flex;align-items:flex-start}
    .barcode .box{background:#fff;border:0.9px solid #dbe2ea;border-radius:4px;padding:1.5mm 2mm}
    .barcode svg{height:16px;max-width:88px;display:block}
    .digits{font-size:8.8pt;letter-spacing:.2px;margin-top:1mm}

    /* メタ情報は印刷では非表示（高さ確保） */
    .meta{display:none !important}

    .price{font-size:10.4pt;font-weight:700}

    .qtywrap{display:grid;grid-template-columns: 16mm 1fr;align-items:center;gap:1.8mm}
    .qtylbl{font-size:9.8pt}
    .qtybox{height:7mm;border:1.2px solid #374151;border-radius:4px}

    /* 左上の番号タグは控えめに（高さ圧迫を避ける） */
    .corner{position:absolute;top:0;left:0;width:0;height:0;border-top:26px solid #ff9900;border-right:26px solid transparent}
    .tag{position:absolute;top:-20px;left:2px;color:#fff;font-weight:800;font-size:11px;}

    /* 12枚で改ページ */
    .card:nth-of-type(12n){page-break-after:always;break-after:page}
  }

  /* 画面確認用の簡易格子（印刷以外で見た目確認したい時用） */
  @media screen{
    .sheet{max-width:900px;margin:16px auto;padding:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .card{border:1px solid #e5e7eb;background:#fff}
    .thumb{aspect-ratio:3/2;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:center}
    .thumb img{max-width:95%;max-height:95%}
    .body{padding:8px;display:grid;gap:6px}
    .barcode .box{border:1px solid #e5e7eb;border-radius:6px;padding:6px 8px}
    .qtybox{height:28px;border:1px solid #94a3b8;border-radius:6px}
  }
</style>
</head>
<body>

<section class="sheet" id="sheet">
  <!-- JSで12件カードを流し込み -->
</section>

<script>
const REPO = "kakaku_Order-Form-";
const BASE = `https://${location.host}/${REPO}`;
const CDN  = "https://cdn.jsdelivr.net/gh/shimacp-studio/kakaku_Order-Form-@main";

async function fetchFirstJSON(urls){
  let lastErr=null;
  for(const u of urls){
    try{const r=await fetch(u,{cache:"no-store"}); if(r.ok) return await r.json(); lastErr=new Error(r.status+"@"+u);}catch(e){lastErr=e;}
  }
  throw lastErr||new Error("load error");
}
function candidates(jan){
  const exts=["png","jpg","jpeg","webp","jfif","PNG","JPG","JPEG","WEBP","JFIF"];
  const bases=[`${BASE}/img/`,`${BASE}/img/jan/`,`${BASE}/img/barcode/`];
  const arr=[]; for(const b of bases){for(const e of exts){arr.push(`${b}${jan}.${e}`)}} return arr;
}
function setBest(img, urls){let i=0; img.onerror=()=>{i<urls.length?img.src=urls[i++]:img.onerror=null}; img.onerror();}

function onlyDigits(s){return (s||"").replace(/[^0-9]/g,"");}
const L=["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"];
const G=["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"];
const R=["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"];
const PAR={"0":"LLLLLL","1":"LLGLGG","2":"LLGGLG","3":"LLGGGL","4":"LGLLGG","5":"LGGLLG","6":"LGGGLL","7":"LGLGLG","8":"LGLGGL","9":"LGGLGL"};
function cd12(d){let s=0; for(let i=0;i<12;i++){const n=+d[i]; s+=(i%2===0)?n:n*3;} return (10-(s%10))%10;}
function pat(d){const ds=onlyDigits(d); if(ds.length<12) return null; const d12=ds.slice(0,12); const cd=(ds.length>=13)?+ds[12]:cd12(d12);
  const first=d12[0], left=d12.slice(1,7), right=d12.slice(7,12)+String(cd), parity=PAR[first]||"LLLLLL"; let bits="101";
  for(let i=0;i<6;i++){const n=+left[i]; bits+= (parity[i]==="L"?L[n]:G[n]);} bits+="01010"; for(let i=0;i<6;i++){bits+=R[+right[i]];} bits+="101"; return bits; }
function svg(jan,w=88,h=16){const bits=pat(jan); if(!bits) return ""; const barW=Math.max(1,Math.floor(w/bits.length)); const W=barW*bits.length; const hg=Math.floor(h*0.92);
  let x=0, s=`<svg viewBox='0 0 ${W} ${h}' xmlns='http://www.w3.org/2000/svg' shape-rendering='crispEdges'><rect width='${W}' height='${h}' fill='#fff'/>`;
  for(let i=0;i<bits.length;i++){ if(bits[i]==='1'){const guard=(i<3)||(i>=45&&i<50)||(i>=92); s+=`<rect x='${x}' y='0' width='${barW}' height='${guard?h:hg}' fill='#111827'/>`; } x+=barW; } return s+`</svg>`; }

const sheet=document.getElementById('sheet');
let PRODUCTS=[];

function addCard(p,idx){
  const el=document.createElement('article');
  el.className='card';
  el.innerHTML=`
    <div class="corner"><span class="tag">${idx+1}</span></div>
    <div class="thumb"><img alt=""></div>
    <div class="body">
      <div class="title">${p.name||""}</div>
      <div class="barcode"><div class="box">${svg(p.jan)}<div class="digits">${p.jan||""}</div></div></div>
      <div class="price">${(p.price!=null?Number(p.price).toLocaleString()+"円":"")}</div>
      <div class="qtywrap"><div class="qtylbl">発注数量：</div><div class="qtybox"></div></div>
    </div>`;
  sheet.appendChild(el);
  const img=el.querySelector('img');
  const urls=candidates(p.jan);
  let i=0; function next(){ if(i>=urls.length){img.src=''; img.onerror=null; return;} img.src=urls[i++]; }
  img.onerror=next; next();
}

async function boot(){
  const here=(new URL('./products.json',location.href)).href;
  const data=await fetchFirstJSON([here,`${BASE}/products.json`,`${CDN}/products.json`]);
  PRODUCTS=Array.isArray(data)?data:[];
  PRODUCTS.slice(0,12).forEach(addCard);
}
boot().catch(e=>alert("初期化エラー:"+e.message));
</script>

</body>
</html>
